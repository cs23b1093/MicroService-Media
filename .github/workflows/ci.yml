name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-build:
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:alpine
        ports: [ "6379:6379" ]
      rabbitmq:
        image: rabbitmq:3-management
        ports: [ "5672:5672", "15672:15672" ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install deps
        run: npm ci

      - name: Lint + Type Check
        run: |
          npm run lint
          npm run build --if-present

      - name: Run Tests
        run: npm test

      - name: Build Docker Images
        run: |
          docker compose build
          # Optional: push to GitHub registry
          # echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          # docker compose push
